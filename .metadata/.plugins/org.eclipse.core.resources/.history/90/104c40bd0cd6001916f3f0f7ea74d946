import java.util.*;

public class Field {

	// CONSTANTS
	public static final char[] BOARD_LETTERS = { 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J' };
	public static final int BOARD_SIZE = 10;

	// VARIABLES
	private HashMap<String, Square> playfield;
	private Ship[] ships;

	public Field() {
		initField();

		initShips();
	}

	public void print() {
		printBoard(false);

		if (Main.CHEAT)
			printBoard(true);
	}

	public HashMap<String, Square> getPlayField() {
		return playfield;
	}

	/**
	 * Prints the board. Starts at maximum height (because of descending order).
	 * 
	 * @param boolean isCheatMode
	 */
	private void printBoard(boolean isCheatMode) {
		for (int y = Field.BOARD_SIZE; y >= 1; y--) {
			String boardRow = "";

			if (y < 10)
				boardRow += " ";

			boardRow += (y + "| ");

			for (char x = 'A'; x <= Field.BOARD_LETTERS[Field.BOARD_SIZE - 1]; x++) {
				Square square = getFromField(x, y);

				Ship ship = square.getShip();
				char icon;
				if (isCheatMode) {
					if (square.hasShip()) {
						icon = ship.getIcon();
					} else {
						icon = Square.WATER;
					}
				} else {
					if (square.hasShip()) {
						if (ship.hasSunk()) {
							icon = ship.getIcon();
						} else if (square.isHit()) {
							icon = Square.HIT;
						} else {
							icon = Square.DOT;
						}
					} else {
						if (square.isHit()) {
							icon = Square.MISSED;
						} else {
							icon = Square.DOT;
						}
					}
				}

				boardRow += icon;
				boardRow += " ";
			}

			System.out.println(boardRow);
		}

		System.out.println("  +--------------------");
		System.out.println("    A B C D E F G H I J");
		System.out.println();
	}

	/**
	 * Initializes the field. Creates the field and adds an empty square to every
	 * coordination.
	 */
	private void initField() {
		playfield = new HashMap<String, Square>();

		for (char x = 'A'; x <= Field.BOARD_LETTERS[Field.BOARD_SIZE - 1]; x++) {
			for (int y = 1; y <= Field.BOARD_SIZE; y++) {
				putInField(x, y);
			}
		}
	}

	/**
	 * Initializes the ships. Creates the array and adds them to the field.
	 */
	private void initShips() {
		this.ships = new Ship[5];

		// Initialize every ship type
		int i = 0;
		for (ShipType type : ShipType.values()) {
			this.ships[i] = new Ship(type);
			i++;
		}

		// Add every ship type to the field
		for (Ship ship : ships)
			placeShip(ship);
	}

	/**
	 * Adds the ship to the field by a random character, number and direction
	 * 
	 * @param Ship ship
	 */
	private void placeShip(Ship ship) {
		char randomStartChar, currentChar;
		int randomStartNr, currentNr;
		boolean isVertical;

		Random rand = new Random();
		randomStartChar = currentChar = Field.BOARD_LETTERS[rand.nextInt(Field.BOARD_SIZE - ship.getLength())];
		randomStartNr = currentNr = rand.nextInt(Field.BOARD_SIZE - ship.getLength()) + 1;
		isVertical = rand.nextBoolean();

		// Check whether the new ship can be placed vertical or not

		if (isValidCoordinate(ship, currentChar, currentNr, isVertical)) {
			if (isVertical) {
				currentNr = randomStartNr;
			} else {
				currentChar = randomStartChar;
			}
			addShipToField(ship, currentChar, currentNr, isVertical);
		} else {
			if (isValidCoordinate(ship, currentChar, currentNr, !isVertical)) {
				if (isVertical) {
					currentNr = randomStartNr;
				} else {
					currentChar = randomStartChar;
				}
				addShipToField(ship, currentChar, currentNr, !isVertical);
			} else {
				placeShip(ship);
			}
		}
	}

	/**
	 * Checks whether the questioned coordinate is valid or not. Loops through every
	 * coordinate. If coordinate not possible, return false.
	 * 
	 * @param Ship    ship
	 * @param char    currentChar
	 * @param int     currentNr
	 * @param boolean isVertical
	 * 
	 * @return boolean isValidCoordinate
	 */
	private boolean isValidCoordinate(Ship ship, char currentChar, int currentNr, boolean isVertical) {
		// If vertical check left and right, if horizontal check above and under
		if (isVertical) {
			System.out.println("--- Vertical ---");
			char startingChar = currentChar--;
			for (int x = -1; x < 2; x++) {
				int startingNr = currentNr--;
				for (int y = -1; y < (ship.getLength() + 1); y++) {
					String coordinate = Character.toString(startingChar) + (startingNr);

					System.out.print(coordinate + " ");
					if (!isValidSquare(coordinate) || !isSquareFree(coordinate)) {
						System.out.println();
						return false;
					}

					startingNr++;
				}
				startingChar++;
			}

			System.out.println();

			return true;
		} else {
			System.out.println("--- Horizontal ---");
			
			int startingNr = currentNr--;
			for (int y = -1; y < 2; y++) {
				char startingChar = currentChar--;
				for (int x = -1; x < (ship.getLength() + 1); x++) {
					String coordinate = Character.toString(startingChar) + startingNr;

					System.out.print(coordinate + " ");
					if (!isValidSquare(coordinate) || !isSquareFree(coordinate)) {
						return false;
					}

					startingChar++;
				}
				startingNr++;
			}

			System.out.println();

			return true;
		}
	}

	/**
	 * Adds an ship to the field. Loop through the length of the ship and adds a
	 * part of the ship to the given coordinate.
	 * 
	 * @param Ship    ship
	 * @param char    currentChar
	 * @param int     currentNr
	 * @param boolean isVertical
	 */
	private void addShipToField(Ship ship, char currentChar, int currentNr, boolean isVertical) {
		for (int i = 0; i < ship.getLength(); i++) {
			putInField(currentChar, currentNr, ship);

			if (isVertical) {
				currentNr++;
			} else {
				currentChar++;
			}
		}
	}

	private boolean isSquareFree(String coordinate) {
		return playfield.get(coordinate).getShip() == null;
	}

	private void putInField(char x, int y) {
		playfield.put(Character.toString(x) + y, new Square());
	}

	private void putInField(char x, int y, Ship ship) {
		playfield.put(Character.toString(x) + y, new Square(ship));
	}

	private Square getFromField(char x, int y) {
		return playfield.get(Character.toString(x) + y);
	}

	/**
	 * Checks whether the input character is valid or not. The character has to be a
	 * character between A and J (the field width).
	 * 
	 * @param char inputChar
	 * 
	 * @return boolean isValidChar
	 */
	private boolean isValidChar(char inputChar) {
		return (inputChar >= 'A' && inputChar <= 'J');
	}

	/**
	 * Checks whether the number is valid or not. The method tries to parse the
	 * string into an Integer. If number is correct, it checks if number is in board
	 * 
	 * @param String inputNr
	 * 
	 * @return boolean isValidNr
	 */
	private boolean isValidNr(String inputNr) {
		try {
			int input = Integer.parseInt(inputNr);
			return (input >= 1 && input <= Field.BOARD_SIZE);
		} catch (NumberFormatException | NullPointerException nfe) {
			return false;
		}
	}

	/**
	 * Checks whether the given input is valid or not. Uses the isValidChar and
	 * isValidNr to check input.
	 * 
	 * @param String input
	 * 
	 * @return boolean isValidSquare
	 */
	private boolean isValidSquare(String input) {
		return isValidChar(input.charAt(0)) && isValidNr(input.substring(1));
	}
}
