import java.util.Scanner;

public class SeaBattle {

	// Variables
	private Player[] players;
	private Player currentPlayer;
	private boolean gameHasFinished = false;

	/**
	 * Creates the array for players by the players that are given.
	 * 
	 * @param players - An array of players from the type Player
	 */
	public void setPlayers(Player[] players) {
		this.players = players;
	}

	/**
	 * Handles the game and tries to play the game. Loops through the players as
	 * long as a game hasn't finished
	 */
	public void play() {
		while (!gameHasFinished) {
			for (Player player : players) {
				if (!gameHasFinished) {
					currentPlayer = player;

					printCurrentField();

					guessCoordinate();
				} else {
					printWinner();
				}
			}
		}
	}

	/**
	 * Asks the player for their wished coordinate. If coordinate incorrect, it
	 * tries again.
	 */
	private void guessCoordinate() {
		System.out.print(currentPlayer.getName() + ", geef de locatie die je wilt beschieten: ");

		@SuppressWarnings("resource")
		Scanner sc = new Scanner(System.in);

		String coordinate = sc.nextLine();

		if (isValidSquare(coordinate)) {
			Square square = getSquareByCoordinate(coordinate);

			if (!square.isHit()) {
				square.setIsHit();

				if (square.hasShip()) {
					System.out.println("Bravo, je hebt een schip geraakt.");

					Ship ship = square.getShip();
					if (ship.hasSunk()) {
						System.out
								.println("Sterker nog, dit schip van het type " + ship.getType() + " is nu gezonken!");

						if (Main.CHEAT) {
							System.out.println("*** Vanwege de cheat mode is het spel nu al afgelopen ***");
							this.endGame();
						}
					} else {
						System.out.println();
					}
				} else {
					System.out.println("Helaas, dat was een misser.");
				}
			} else {
				System.out.println("*** Die locatie heb je al eerder beschoten ***");
				guessCoordinate();
			}
		} else {
			if (coordinate.trim().isEmpty()) {
				System.out.println("*** Graag een coordinatie geven alstublieft!");
			} else {
				if (!isValidChar(coordinate.charAt(0))) {
					System.out.println("*** Kolom " + coordinate.charAt(0) + " bestaat niet");
				}

				if (!isValidNr(coordinate.substring(1))) {
					System.out.println("*** Rij " + coordinate.substring(1) + " bestaat niet");
				}
			}

			guessCoordinate();
		}
	}

	private void endGame() {
		this.gameHasFinished = true;
	}

	/**
	 * Prints the field of the current player.
	 */
	private void printCurrentField() {
		System.out.println();
		System.out.println("*** Aan de beurt: " + currentPlayer.getName() + " ***");
		System.out.println();
		currentPlayer.printField();
	}

	/**
	 * Prints the currentPlayer, assuming that he is the winner.
	 */
	private void printWinner() {
		System.out.println(
				"Bravo " + currentPlayer.getName() + ", je hebt alle schepen van je tegenstander tot zinken gebracht!");
		System.out.println("Je bent de trotse winnaar van dit spel!");
	}

	/**
	 * Returns the square for the given coordinate.
	 * 
	 * @param String coordinate
	 * 
	 * @return Square coordinateSquare
	 */
	private Square getSquareByCoordinate(String coordinate) {
		return currentPlayer.getField().getPlayField().get(coordinate);
	}

	/**
	 * Checks whether the input character is valid or not. The character has to be a
	 * character between A and J (the field width).
	 * 
	 * @param char inputChar
	 * 
	 * @return boolean isValidChar
	 */
	private boolean isValidChar(char inputChar) {
		return (inputChar >= 'A' && inputChar <= 'J');
	}

	/**
	 * Checks whether the number is valid or not. The method tries to parse the
	 * string into an Integer. If number is correct, it checks if number is in board
	 * 
	 * @param String inputNr
	 * 
	 * @return boolean isValidNr
	 */
	private boolean isValidNr(String inputNr) {
		try {
			int input = Integer.parseInt(inputNr);
			return (input >= 1 && input <= Field.SIZE);
		} catch (NumberFormatException | NullPointerException nfe) {
			return false;
		}
	}

	/**
	 * Checks whether the given input is valid or not. Uses the isValidChar and
	 * isValidNr to check input.
	 * 
	 * @param String input
	 * 
	 * @return boolean isValidSquare
	 */
	private boolean isValidSquare(String input) {
		return isValidChar(input.charAt(0)) && isValidNr(input.substring(1));
	}
}
